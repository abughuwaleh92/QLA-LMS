<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QLA Mathematics — Teacher Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Poppins:wght@600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    :root{ --maroon:#6C1D45; --maroon2:#8B2450; --gold:#C7A34F; --gold2:#E4D4A8; --ink:#0F172A; --slate:#5b6572; --line:#e9eef2; --bg:#F7FAFC; --ok:#136f3a; --soon:#8a3d00; --purple:#7C3AED; --blue:#1D4ED8; }
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
    .hero{position:relative;color:#fff;background:linear-gradient(135deg,rgba(108,29,69,.9) 0%,rgba(139,36,80,.86) 45%,rgba(108,29,69,.9) 100%);overflow:hidden}
    .hero::before{content:"";position:absolute;inset:-40% -40% auto auto;width:200%;height:200%;background:radial-gradient(circle,rgba(199,163,79,.22) 0%,transparent 70%);animation:float 22s ease-in-out infinite;pointer-events:none}
    @keyframes float{0%,100%{transform:translate(0,0) rotate(0)} 33%{transform:translate(30px,-30px) rotate(120deg)} 66%{transform:translate(-20px,20px) rotate(240deg)}}
    @media (prefers-reduced-motion: reduce){ .hero::before{animation:none} }
    .nav-tabs{ display:flex; gap:8px; background:rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.35); border-radius:14px; padding:6px; flex-wrap:wrap }
    .nav-tab{ flex:1; min-width:120px; padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.35); color:#fff; background:transparent; cursor:pointer; font-weight:600; text-align:center; transition:all .3s ease }
    .nav-tab.active{ background:linear-gradient(135deg,var(--gold),var(--gold2)); color:var(--maroon); transform:scale(1.02) }
    .card{ background:#fff; border:1px solid var(--line); border-radius:18px; transition:all .3s ease }
    .card:hover{ transform:translateY(-2px); box-shadow:0 20px 40px rgba(0,0,0,.1) }
    .interactive-row{ border:1px solid var(--line); border-radius:12px; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; background:#fff; transition:all .3s ease; cursor:pointer; position:relative; overflow:hidden }
    .interactive-row::before{ content:""; position:absolute; left:-100%; top:0; bottom:0; width:4px; background:linear-gradient(135deg,var(--gold),var(--maroon)); transition:left .3s ease }
    .interactive-row:hover{ transform:translateX(4px); box-shadow:0 12px 28px rgba(0,0,0,.08) }
    .interactive-row:hover::before{ left:0 } .interactive-row.completed::before{ left:0; background:var(--ok) }
    .status{font-size:11px; padding:6px 12px; border-radius:999px; border:1px solid transparent; text-transform:uppercase; letter-spacing:.3px; font-weight:600}
    .open{ background:rgba(19,111,58,.1); color:var(--ok); border-color:rgba(19,111,58,.25) }
    .soon{ background:rgba(186,91,8,.08); color:var(--soon); border-color:rgba(186,91,8,.25) }
    .completed{ background:rgba(124,58,237,.1); color:var(--purple); border-color:rgba(124,58,237,.25) }
    iframe.lesson-frame{width:100%;height:60vh;border:1px solid var(--line);border-radius:14px}
    textarea.code{ min-height:220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border:1px solid var(--line); border-radius:12px; padding:12px }
  </style>
</head>
<body>
  <header class="hero">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
      <div class="flex items-center justify-between py-6">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-[var(--maroon)] rounded-lg flex items-center justify-center text-white font-bold text-xl">QLA</div>
          <div><h1 class="text-3xl lg:text-5xl font-extrabold" style="font-family:Poppins,Inter,sans-serif">Teacher Portal</h1>
            <p class="text-sm opacity-90 mt-1">Qatar Leadership Academy</p></div>
        </div>
        <div class="hidden lg:flex items-center gap-4"><div class="bg-white/10 backdrop-blur rounded-full p-2"><i class="fas fa-user-tie text-2xl"></i></div>
          <div class="text-right"><div class="font-semibold">Teacher</div><div class="text-xs opacity-80">Have a great class!</div></div></div>
      </div>
      <div class="pb-6 flex flex-col gap-4">
        <div class="nav-tabs" role="tablist" aria-label="Main navigation">
          <button class="nav-tab active" data-tab="lessons"><i class="fas fa-book mr-2"></i>Lessons</button>
          <button class="nav-tab" data-tab="create"><i class="fas fa-plus mr-2"></i>Create Lesson</button>
          <button class="nav-tab" data-tab="assign"><i class="fas fa-tasks mr-2"></i>Assignments</button>
          <button class="nav-tab" data-tab="live"><i class="fas fa-chalkboard-teacher mr-2"></i>Classroom Mode</button>
          <button class="nav-tab" data-tab="analytics"><i class="fas fa-chart-simple mr-2"></i>Analytics</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Manage Lessons -->
    <section id="lessons-tab" class="tab-content">
      <div class="card p-5 mb-4">
        <div class="flex items-center justify-between">
          <div class="font-bold"><i class="fas fa-book mr-2 text-[var(--maroon)]"></i>My Lessons</div>
          <div class="flex items-center gap-3">
            <select id="filterGrade" class="rounded-lg border px-2 py-1">
              <option value="all">All Grades</option><option value="7">Grade 7</option><option value="8">Grade 8</option>
            </select>
            <input id="searchLessons" class="rounded-lg border px-3 py-2" placeholder="Search by title"/>
          </div>
        </div>
      </div>
      <div id="lessonsList" class="grid gap-4 md:grid-cols-2"></div>
    </section>

    <!-- Create Lesson -->
    <section id="create-tab" class="tab-content hidden">
      <div class="grid gap-6 md:grid-cols-2">
        <div class="card p-6">
          <h3 class="font-bold text-lg mb-4"><i class="fas fa-pen-to-square mr-2 text-[var(--gold)]"></i>Lesson Details</h3>
          <div class="grid gap-3">
            <label class="text-sm">Title <input id="title" class="rounded-lg border px-3 py-2 w-full"/></label>
            <div class="grid grid-cols-3 gap-3">
              <label class="text-sm col-span-1">Grade <select id="grade" class="rounded-lg border px-3 py-2 w-full"><option>7</option><option>8</option></select></label>
              <label class="text-sm col-span-1">Unit <input id="unit" type="number" min="1" class="rounded-lg border px-3 py-2 w-full" value="1"/></label>
              <label class="text-sm col-span-1">Order <input id="order" type="number" min="1" class="rounded-lg border px-3 py-2 w-full" value="1"/></label>
            </div>
            <label class="text-sm">Description <input id="description" class="rounded-lg border px-3 py-2 w-full"/></label>
          </div>
        </div>
        <div class="card p-6">
          <h3 class="font-bold text-lg mb-4"><i class="fas fa-video mr-2 text-[var(--gold)]"></i>Video</h3>
          <div class="grid gap-3">
            <label class="text-sm">Video URL (YouTube/Vimeo or direct) <input id="videoUrl" class="rounded-lg border px-3 py-2 w-full"/></label>
            <div class="text-center text-sm text-slate-600">— or —</div>
            <label class="text-sm">Upload Video <input id="videoFile" type="file" accept="video/*" class="rounded-lg border px-3 py-2 w-full"/></label>
            <button class="bg-[var(--maroon)] text-white px-4 py-2 rounded-lg hover:bg-[var(--maroon2)]" onclick="uploadVideo()">Upload</button>
            <div id="videoUploadResult" class="text-sm text-slate-600"></div>
          </div>
        </div>
      </div>
      <div class="card p-6 mt-6">
        <h3 class="font-bold text-lg mb-2"><i class="fas fa-code mr-2 text-[var(--gold)]"></i>Lesson HTML (interactive)</h3>
        <textarea id="htmlContent" class="code" placeholder="Paste or author your interactive HTML (include inputs, buttons, scripts)."></textarea>
        <div class="mt-4 flex items-center gap-3">
          <button class="bg-[var(--ok)] text-white px-6 py-2 rounded-lg hover:opacity-80" onclick="saveLesson()">Save Lesson</button>
          <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700" onclick="previewHTML()">Preview</button>
        </div>
        <div id="previewWrap" class="mt-4 hidden">
          <iframe id="previewFrame" class="lesson-frame" srcdoc="<p>Preview</p>"></iframe>
        </div>
      </div>
    </section>

    <!-- Assignments -->
    <section id="assign-tab" class="tab-content hidden">
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-4"><i class="fas fa-list-check mr-2 text-[var(--gold)]"></i>Create Assignment</h3>
        <div class="grid gap-3 md:grid-cols-2">
          <label class="text-sm">Select Lesson
            <select id="assignLesson" class="rounded-lg border px-3 py-2 w-full"></select>
          </label>
          <label class="text-sm">Class Code <input id="classCode" class="rounded-lg border px-3 py-2 w-full" placeholder="e.g., MATH7A"/></label>
          <label class="text-sm">Pass % <input id="passPct" type="number" min="0" max="100" value="70" class="rounded-lg border px-3 py-2 w-full"/></label>
          <label class="text-sm">Due Date <input id="dueDate" type="date" class="rounded-lg border px-3 py-2 w-full"/></label>
        </div>
        <div class="mt-4"><button class="bg-[var(--maroon)] text-white px-6 py-2 rounded-lg hover:bg-[var(--maroon2)]" onclick="createAssignment()">Assign</button></div>
        <div id="assignResult" class="text-sm text-slate-600 mt-3"></div>
      </div>
      <div class="card p-6 mt-6">
        <h3 class="font-bold text-lg mb-4"><i class="fas fa-table mr-2 text-[var(--gold)]"></i>Assignments</h3>
        <div id="assignmentsList" class="space-y-2"></div>
      </div>
    </section>

    <!-- Live Classroom -->
    <section id="live-tab" class="tab-content hidden">
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-4"><i class="fas fa-broadcast-tower mr-2 text-[var(--gold)]"></i>Presentation</h3>
        <div class="grid gap-3 md:grid-cols-2">
          <label class="text-sm">Class Code <input id="liveCode" class="rounded-lg border px-3 py-2 w-full" value="MATH7A"/></label>
          <label class="text-sm">Grade <select id="liveGrade" class="rounded-lg border px-3 py-2 w-full"><option>7</option><option>8</option></select></label>
          <label class="text-sm md:col-span-2">Go to Lesson ID <input id="liveLessonId" class="rounded-lg border px-3 py-2 w-full" placeholder="e.g., 7-1-2"/></label>
        </div>
        <div class="mt-4 flex items-center gap-3">
          <button class="bg-[var(--blue)] text-white px-6 py-2 rounded-lg hover:opacity-90" onclick="startBroadcast()">Start</button>
          <button class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700" onclick="sendGoto()">Send: Go To Lesson</button>
        </div>
        <div id="liveLog" class="mt-4 text-sm text-slate-600"></div>
      </div>
    </section>

    <!-- Analytics (placeholder) -->
    <section id="analytics-tab" class="tab-content hidden">
      <div class="card p-6">
        <h3 class="font-bold text-lg mb-2"><i class="fas fa-chart-simple mr-2 text-[var(--gold)]"></i>Overview</h3>
        <p class="text-slate-600">Assignment completion and assessment results will appear here.</p>
      </div>
    </section>
  </main>

<script>
const socket = typeof io !== 'undefined' ? io() : null;
function switchTab(tab){ document.querySelectorAll('.nav-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab)); document.querySelectorAll('.tab-content').forEach(c=>c.classList.toggle('hidden', !c.id.startsWith(tab))); }
document.querySelectorAll('.nav-tab').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
function show(msg,type='info'){ const c={success:'bg-[var(--ok)]',error:'bg-red-600',info:'bg-[var(--blue)]'}; const n=document.createElement('div'); n.className=`fixed top-4 right-4 z-50 p-3 rounded-lg text-white ${c[type]}`; n.textContent=msg; document.body.appendChild(n); setTimeout(()=>n.remove(),2500); }
function api(path,opts){ return fetch(path,Object.assign({headers:{'Content-Type':'application/json'}},opts||{})).then(r=>r.ok?r.json():r.text().then(t=>Promise.reject(new Error(t||r.statusText)))); }

// Load lessons
async function loadLessons(){
  const res = await api('/api/lessons/catalog?all=1');
  const list = document.getElementById('lessonsList'); list.innerHTML='';
  const sel = document.getElementById('assignLesson'); sel.innerHTML='';
  (res.units||[]).forEach(u=> (u.lessons||[]).forEach(L=>{
    const card = document.createElement('div'); card.className='card p-4';
    card.innerHTML = `<div class="font-semibold mb-1">${L.title}</div>
      <div class="text-sm text-slate-600">Grade ${L.grade} • Unit ${L.unit} • Order ${L.order}</div>
      <div class="mt-2 flex items-center gap-2">
        <button class="bg-[var(--blue)] text-white px-3 py-1 rounded" onclick="preview('${L.src||''}','${(L.title||'').replace(/'/g,'\\'')}')">Preview</button>
        <button class="bg-[var(--maroon)] text-white px-3 py-1 rounded" onclick="editLesson('${L.id}')">Edit</button>
        <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="delLesson('${L.id}')">Delete</button>
      </div>`;
    list.appendChild(card);
    const opt = document.createElement('option'); opt.value = L.id; opt.textContent = `${L.title} (G${L.grade} U${L.unit} L${L.order})`; sel.appendChild(opt);
  }));
}
// Create lesson
async function uploadVideo(){
  const f = document.getElementById('videoFile').files[0]; if (!f) return show('Choose a video file','error');
  const fd = new FormData(); fd.append('video', f);
  const r = await fetch('/api/uploads/video', { method:'POST', body:fd }); if (!r.ok) return show('Upload failed','error');
  const j = await r.json(); document.getElementById('videoUploadResult').textContent = 'Uploaded: '+j.url; document.getElementById('videoUrl').value = j.url; show('Uploaded','success');
}
function previewHTML(){ const html = document.getElementById('htmlContent').value||'<p>No content</p>'; const f = document.getElementById('previewFrame'); document.getElementById('previewWrap').classList.remove('hidden'); f.srcdoc = html + '<script src=\"/js/lesson-bridge.js\"></'+'script>'; }
async function saveLesson(){
  const payload = { title:document.getElementById('title').value, grade:parseInt(document.getElementById('grade').value), unit:parseInt(document.getElementById('unit').value), lesson_order:parseInt(document.getElementById('order').value), description:document.getElementById('description').value, video_url:document.getElementById('videoUrl').value||null, html_content:document.getElementById('htmlContent').value };
  const j = await api('/api/lessons', { method:'POST', body: JSON.stringify(payload) }); show('Lesson saved','success'); loadLessons();
}
async function editLesson(id){ const title = prompt('New title (leave blank to skip):'); const body = {}; if (title) body.title = title; if (Object.keys(body).length===0) return; await api('/api/lessons/'+id, { method:'PUT', body: JSON.stringify(body) }); show('Updated','success'); loadLessons(); }
async function delLesson(id){ if (!confirm('Delete this lesson?')) return; await api('/api/lessons/'+id, { method:'DELETE' }); show('Deleted','success'); loadLessons(); }
function preview(src,title){ const w = window.open(src||'#','_blank'); if (!src) show('No static HTML bound; if you used html_content it will render from DB in student portal.','info'); }

// Assignments
async function createAssignment(){
  const payload = { lesson_id: document.getElementById('assignLesson').value, class_code: document.getElementById('classCode').value, pass_pct: parseInt(document.getElementById('passPct').value)||70, due_at: document.getElementById('dueDate').value||null };
  const r = await api('/api/assignments', { method:'POST', body: JSON.stringify(payload) });
  document.getElementById('assignResult').textContent = `Assigned to ${r.class_code} (pass ${r.pass_pct}%)`; show('Assignment created','success'); loadAssignments();
}
async function loadAssignments(){ const r = await api('/api/assignments'); const list = document.getElementById('assignmentsList'); list.innerHTML=''; (r||[]).forEach(a=>{ const div=document.createElement('div'); div.className='interactive-row'; div.innerHTML=`<div><div class="font-semibold">Lesson ${a.lesson_id} → ${a.class_code}</div><div class="text-sm text-slate-600">Due: ${a.due_at||'—'} • Pass: ${a.pass_pct}%</div></div><span class="status open">Active</span>`; list.appendChild(div); }); }

// Live broadcast
function startBroadcast(){ const code = document.getElementById('liveCode').value; socket.emit('class:start', { code }); show('Broadcast started','success'); log(`Started class ${code}`); }
function sendGoto(){ const code = document.getElementById('liveCode').value; const grade = parseInt(document.getElementById('liveGrade').value); const lessonId = document.getElementById('liveLessonId').value; socket.emit('class:event',{ code, action:'gotoLesson', grade, lessonId, title:'Live lesson', ts:Date.now() }); log(`Sent goto → ${lessonId}`); }
function log(msg){ const el = document.getElementById('liveLog'); el.innerHTML += `<div>• ${new Date().toLocaleTimeString()} — ${msg}</div>`; }

// Init
async function init(){ await loadLessons(); await loadAssignments(); }
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
